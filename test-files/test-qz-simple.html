<!DOCTYPE html>
<html>
<head>
    <title>Teste QZ Tray Simples</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>Teste QZ Tray - Conex√£o Simples</h1>
    <div id="status">Iniciando...</div>
    <button onclick="testSimpleConnection()">Testar Conex√£o Simples</button>
    <button onclick="testWithTimeout()">Testar com Timeout</button>
    <button onclick="testMultiplePorts()">Testar M√∫ltiplas Portas</button>
    
    <div id="logs" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; font-family: monospace;"></div>

    <script>
        function log(message, color = 'black') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `[${timestamp}] ${message}`;
            div.style.color = color;
            div.style.marginBottom = '3px';
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, color = 'black') {
            document.getElementById('status').innerHTML = message;
            document.getElementById('status').style.color = color;
        }

        // Teste de conex√£o mais simples poss√≠vel
        function testSimpleConnection() {
            log('=== TESTE CONEX√ÉO SIMPLES ===', 'blue');
            updateStatus('Testando...', 'orange');
            
            const ws = new WebSocket('ws://localhost:8181');
            
            ws.onopen = function() {
                log('‚úÖ WebSocket ABERTO!', 'green');
                updateStatus('‚úÖ Conectado!', 'green');
                
                // Enviar comando mais simples
                log('Enviando comando ping...', 'blue');
                ws.send('ping');
            };
            
            ws.onmessage = function(event) {
                log('üì® Mensagem recebida: ' + event.data, 'green');
                
                // Tentar comando de vers√£o
                log('Enviando comando getVersion...', 'blue');
                const cmd = JSON.stringify({
                    call: 'getVersion',
                    params: []
                });
                ws.send(cmd);
            };
            
            ws.onerror = function(error) {
                log('‚ùå ERRO WebSocket: ' + error, 'red');
                updateStatus('‚ùå Erro na conex√£o', 'red');
            };
            
            ws.onclose = function(event) {
                log(`üîí WebSocket FECHADO - C√≥digo: ${event.code}, Raz√£o: ${event.reason || 'N/A'}`, 'orange');
                if (event.code !== 1000) {
                    updateStatus('‚ùå Conex√£o fechada inesperadamente', 'red');
                }
            };
        }

        // Teste com timeout
        function testWithTimeout() {
            log('=== TESTE COM TIMEOUT ===', 'blue');
            updateStatus('Testando com timeout...', 'orange');
            
            const ws = new WebSocket('ws://localhost:8181');
            let connected = false;
            
            // Timeout de 10 segundos
            const timeout = setTimeout(() => {
                if (!connected) {
                    log('‚è∞ TIMEOUT - Conex√£o demorou mais de 10s', 'red');
                    updateStatus('‚ùå Timeout', 'red');
                    ws.close();
                }
            }, 10000);
            
            ws.onopen = function() {
                connected = true;
                clearTimeout(timeout);
                log('‚úÖ Conectado dentro do timeout!', 'green');
                updateStatus('‚úÖ Conectado!', 'green');
                
                // Teste de echo
                ws.send('test-echo');
            };
            
            ws.onmessage = function(event) {
                log('üì® Resposta: ' + event.data, 'green');
            };
            
            ws.onerror = function(error) {
                clearTimeout(timeout);
                log('‚ùå Erro: ' + error, 'red');
                updateStatus('‚ùå Erro', 'red');
            };
            
            ws.onclose = function(event) {
                clearTimeout(timeout);
                log(`üîí Fechado - ${event.code}: ${event.reason || 'N/A'}`, 'orange');
            };
        }

        // Teste m√∫ltiplas portas
        async function testMultiplePorts() {
            log('=== TESTE M√öLTIPLAS PORTAS ===', 'blue');
            updateStatus('Testando m√∫ltiplas portas...', 'orange');
            
            const ports = [
                { port: 8181, protocol: 'ws', name: 'HTTP' },
                { port: 8182, protocol: 'wss', name: 'HTTPS' },
                { port: 8080, protocol: 'ws', name: 'Alt HTTP' },
                { port: 8443, protocol: 'wss', name: 'Alt HTTPS' }
            ];
            
            for (const config of ports) {
                await testPort(config);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1s entre testes
            }
        }
        
        function testPort(config) {
            return new Promise((resolve) => {
                log(`Testando ${config.name} (${config.protocol}://localhost:${config.port})...`, 'blue');
                
                const ws = new WebSocket(`${config.protocol}://localhost:${config.port}`);
                let resolved = false;
                
                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        log(`‚ùå ${config.name} - Timeout`, 'red');
                        ws.close();
                        resolve(false);
                    }
                }, 3000);
                
                ws.onopen = function() {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        log(`‚úÖ ${config.name} - CONECTADO!`, 'green');
                        updateStatus(`‚úÖ ${config.name} funcionando!`, 'green');
                        ws.close();
                        resolve(true);
                    }
                };
                
                ws.onerror = function(error) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        log(`‚ùå ${config.name} - Erro: ${error}`, 'red');
                        resolve(false);
                    }
                };
                
                ws.onclose = function(event) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        log(`‚ùå ${config.name} - Fechado: ${event.code}`, 'red');
                        resolve(false);
                    }
                };
            });
        }

        // Executar teste autom√°tico
        window.onload = function() {
            updateStatus('Pronto para testes', 'blue');
            log('P√°gina carregada. Clique nos bot√µes para testar.', 'blue');
            
            // Executar teste simples automaticamente
            setTimeout(testSimpleConnection, 1000);
        };
    </script>
</body>
</html>