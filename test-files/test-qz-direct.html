<!DOCTYPE html>
<html>
<head>
    <title>Teste Direto QZ Tray</title>
    <script src="./src/utils/qz-tray-official.js"></script>
</head>
<body>
    <h1>Teste de Conex√£o QZ Tray</h1>
    <div id="status">Carregando...</div>
    <button onclick="testConnection()">Testar Conex√£o</button>
    <div id="logs"></div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>';
        }

        function updateStatus(message, color = 'black') {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.style.color = color;
        }

        async function testConnection() {
            try {
                log('Iniciando teste de conex√£o...');
                
                // Verificar se QZ est√° dispon√≠vel
                if (typeof qz === 'undefined') {
                    throw new Error('QZ Tray library n√£o carregada');
                }
                log('‚úÖ QZ Tray library carregada');

                // Configurar certificado vazio para desenvolvimento
                qz.security.setCertificatePromise(() => Promise.resolve(''));
                log('‚úÖ Certificado configurado');

                // Configurar assinatura simples
                qz.security.setSignaturePromise((toSign, resolve) => {
                    resolve('');
                });
                log('‚úÖ Assinatura configurada');

                // Tentar conectar
                if (!qz.websocket.isActive()) {
                    log('Conectando ao QZ Tray...');
                    await qz.websocket.connect();
                }

                if (qz.websocket.isActive()) {
                    updateStatus('‚úÖ CONECTADO', 'green');
                    log('‚úÖ Conex√£o estabelecida com sucesso!');
                    
                    // Obter vers√£o
                    try {
                        const version = await qz.websocket.getVersion();
                        log('üìã Vers√£o QZ Tray: ' + version);
                    } catch (e) {
                        log('‚ö†Ô∏è N√£o foi poss√≠vel obter a vers√£o');
                    }

                    // Listar impressoras
                    try {
                        const printers = await qz.printers.find();
                        log('üñ®Ô∏è Impressoras encontradas: ' + printers.length);
                        printers.forEach(printer => {
                            log('  - ' + printer);
                        });
                    } catch (e) {
                        log('‚ö†Ô∏è Erro ao listar impressoras: ' + e.message);
                    }
                } else {
                    updateStatus('‚ùå FALHA NA CONEX√ÉO', 'red');
                    log('‚ùå Falha na conex√£o');
                }
            } catch (error) {
                updateStatus('‚ùå ERRO: ' + error.message, 'red');
                log('‚ùå Erro: ' + error.message);
                console.error('Erro detalhado:', error);
            }
        }

        // Testar automaticamente quando a p√°gina carregar
        window.onload = function() {
            setTimeout(testConnection, 1000);
        };
    </script>
</body>
</html>